<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Pixel Planet</title>
    <!-- Favicon (Ensure you have a favicon.ico in your project directory) -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* CSS Variables for Theming */
        :root {
            --background-color: linear-gradient(135deg, #1e1e1e, #2c2c2c);
            --text-color: #ffffff;
            --button-color: #4CAF50;
            --button-hover-color: #45a049;
            --upgrade-bg-color: #333;
            --achievement-unlocked-bg: #4CAF50;
            --event-bg-color: #444;
            --biome-bg-color: #2e2e2e;
            --notification-bg-color: rgba(0, 0, 0, 0.8);
            --modal-bg-color: rgba(0, 0, 0, 0.9);
            --modal-content-bg: #2e2e2e;
            --link-color: #4CAF50;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Dark Theme */
        body.dark-theme {
            --background-color: linear-gradient(135deg, #121212, #1e1e1e);
            --text-color: #e0e0e0;
            --button-color: #bb86fc;
            --button-hover-color: #3700b3;
            --upgrade-bg-color: #1f1f1f;
            --achievement-unlocked-bg: #03dac6;
            --event-bg-color: #333;
            --biome-bg-color: #1e1e1e;
            --notification-bg-color: rgba(0, 0, 0, 0.9);
            --modal-content-bg: #1f1f1f;
            --link-color: #bb86fc;
        }

        /* Light Theme */
        body.light-theme {
            --background-color: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            --text-color: #000000;
            --button-color: #4CAF50;
            --button-hover-color: #45a049;
            --upgrade-bg-color: #ffffff;
            --achievement-unlocked-bg: #4CAF50;
            --event-bg-color: #e0e0e0;
            --biome-bg-color: #f9f9f9;
            --notification-bg-color: rgba(255, 255, 255, 0.9);
            --modal-content-bg: #ffffff;
            --link-color: #4CAF50;
        }

        /* General Styles */
        body {
            font-family: var(--font-family);
            background: var(--background-color);
            color: var(--text-color);
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background 0.5s, color 0.5s;
        }

        /* Notification */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--notification-bg-color);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
            max-width: 300px;
            word-wrap: break-word;
        }

        @keyframes fadein {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeout {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Credits */
        #credits {
            position: fixed;
            top: 10px;
            left: 10px;
            color: var(--text-color);
            font-size: 0.9em;
        }

        #credits a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
        }

        #credits a:hover {
            text-decoration: underline;
        }

        /* Version Number */
        #version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: var(--text-color);
            font-size: 0.8em;
        }

        /* Help Modal */
        #help-modal {
            display: none; /* Hidden by default */
            position: fixed; 
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: var(--modal-bg-color); 
        }

        #help-modal-content {
            background-color: var(--modal-content-bg);
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 600px;
            border-radius: 10px;
            color: var(--text-color);
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #help-modal-content h2 {
            text-align: center;
        }

        #close-help {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        #close-help:hover,
        #close-help:focus {
            color: #000;
            text-decoration: none;
        }

        /* Main Menu and Game Container */
        #main-menu, #game {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Headings */
        h1, h2, h3, h4 {
            margin: 10px 0;
        }

        /* Buttons */
        button {
            padding: 12px 24px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            background-color: var(--button-color);
            color: var(--text-color);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            min-width: 150px;
        }

        button:hover {
            background-color: var(--button-hover-color);
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background-color: #888;
            cursor: not-allowed;
            transform: none;
        }

        /* Resources and Upgrades */
        .resource, .upgrade, .achievement, .event, .biome, .quest {
            font-size: 1.2em;
            margin: 10px 0;
        }

        /* Biomes */
        .biome {
            margin: 10px;
            padding: 15px;
            border: 2px solid #444;
            display: inline-block;
            border-radius: 8px;
            background-color: var(--biome-bg-color);
            width: 150px;
            white-space: pre-line;
            word-wrap: break-word;
            transition: background-color 0.5s, color 0.5s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Upgrades Section */
        #upgrades {
            margin-top: 20px;
            width: 90%;
            max-width: 1000px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .upgrade {
            background-color: var(--upgrade-bg-color);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            width: 220px;
            text-align: left;
            transition: background-color 0.5s, color 0.5s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .upgrade span {
            display: block;
            margin-bottom: 10px;
        }

        .upgrade-button {
            background-color: #008CBA;
            transition: background-color 0.3s;
        }

        .upgrade-button:hover {
            background-color: #007bb5;
        }

        /* Achievements Section */
        #achievements {
            margin-top: 20px;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .achievement {
            background-color: var(--upgrade-bg-color);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            width: 220px;
            text-align: left;
            transition: background-color 0.5s, color 0.5s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .achievement.unlocked {
            background-color: var(--achievement-unlocked-bg);
            color: #ffffff;
            font-weight: bold;
        }

        /* Events Section */
        #events {
            margin-top: 20px;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .event {
            background-color: var(--event-bg-color);
            border: 1px solid #666;
            border-radius: 8px;
            padding: 15px;
            width: 220px;
            text-align: left;
            white-space: pre-line;
            word-wrap: break-word;
            transition: background-color 0.5s, color 0.5s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Quests Section */
        #quests {
            margin-top: 20px;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .quest {
            background-color: var(--upgrade-bg-color);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            width: 220px;
            text-align: left;
            transition: background-color 0.5s, color 0.5s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Theme Selector */
        #theme-selector {
            margin-top: 10px;
        }

        /* Help Button */
        #help-button {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #f39c12;
            color: #ffffff;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            z-index: 1002;
            font-size: 1em;
        }

        #help-button:hover {
            background-color: #e67e22;
            transform: scale(1.05);
        }

        #help-button:active {
            transform: scale(0.95);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .upgrade, .achievement, .event, .biome, .quest {
                width: 45%;
            }
        }

        @media (max-width: 768px) {
            .upgrade, .achievement, .event, .biome, .quest {
                width: 70%;
            }
        }

        @media (max-width: 480px) {
            button {
                width: 80%;
                font-size: 1em;
            }

            .upgrade, .achievement, .event, .biome, .quest {
                width: 90%;
            }
        }

        /* Adjustments for Trackpads and Touch Devices */
        button {
            touch-action: manipulation;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- Credits -->
    <div id="credits">
        Made By <a href="https://your-google-site-link.com" target="_blank" rel="noopener noreferrer">Static</a>
    </div>

    <!-- Version Number -->
    <div id="version">
        Version 0.2
    </div>

    <!-- Help Button -->
    <div id="help-button" onclick="openHelp()" aria-label="Open Help Modal">‚ùì Help</div>

    <!-- Notification -->
    <div id="notification" aria-live="polite"></div>

    <!-- Help Modal -->
    <div id="help-modal" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
        <div id="help-modal-content">
            <span id="close-help" onclick="closeHelp()" aria-label="Close Help Modal">&times;</span>
            <h2 id="help-modal-title">üìñ Pixel Planet Help</h2>
            <p>Welcome to Pixel Planet! Here's how to play:</p>
            <ul>
                <li><strong>Start New Game:</strong> Begin your journey by clicking the "Start New Game" button.</li>
                <li><strong>Generate Resources:</strong> Click the "Generate Resources" button to manually collect resources.</li>
                <li><strong>Upgrades:</strong> Purchase upgrades to increase your resource generation rates and improve efficiency. Upgrades can be bought multiple times, with each purchase increasing their effectiveness and cost.</li>
                <li><strong>Terraform Planet:</strong> Spend Water to unlock new biomes. Each biome provides unique resource bonuses.</li>
                <li><strong>Achievements:</strong> Unlock achievements by reaching specific milestones. Each achievement grants you rewards.</li>
                <li><strong>Events:</strong> Random events occur periodically, affecting your resources positively or negatively. Stay prepared!</li>
                <li><strong>Quests:</strong> Complete daily and weekly quests to earn additional rewards.</li>
                <li><strong>Save Game:</strong> Your game is autosaved every 30 seconds and whenever your stats change. You can also manually save your game by clicking the "Save Game" button.</li>
                <li><strong>Themes:</strong> Choose between different themes (Default, Dark, Light) to customize the game's appearance.</li>
                <li><strong>Help:</strong> Click the "Help" button anytime to access this guide.</li>
            </ul>
            <p>Enjoy building and managing your Pixel Planet! üåçüöÄ</p>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="main-menu">
        <h1>üåç Pixel Planet</h1>
        <button onclick="startNewGame()" aria-label="Start New Game">üöÄ Start New Game</button>
    </div>

    <!-- Game Interface -->
    <div id="game" style="display: none;">
        <h2>Your Planet</h2>
        <div id="resources">
            <div class="resource" id="water">üíß Water: 0 / 1000 (Per Second: <span id="water-rate">1</span>)</div>
            <div class="resource" id="minerals">‚õè Minerals: 0 / 500 (Per Second: <span id="minerals-rate">0</span>)</div>
            <div class="resource" id="plants">üå± Plants: 0 / 300 (Per Second: <span id="plants-rate">0</span>)</div>
            <div class="resource" id="energy">‚ö° Energy: 0 / 200 (Per Second: <span id="energy-rate">0</span>)</div>
        </div>
        <button onclick="generateResources()" aria-label="Generate Resources">üîÑ Generate Resources</button>

        <!-- Biomes Section -->
        <h3>üåø Biomes</h3>
        <div id="biomes">
            <!-- Biomes will be dynamically generated -->
        </div>

        <!-- Upgrades Section -->
        <h3>üíº Upgrades</h3>
        <div id="upgrades">
            <!-- Upgrades will be dynamically generated -->
        </div>

        <!-- Achievements Section -->
        <h3>üèÜ Achievements</h3>
        <div id="achievements">
            <!-- Achievements will be dynamically generated -->
        </div>

        <!-- Events Section -->
        <h3>üéâ Events</h3>
        <div id="events">
            <!-- Events will be dynamically generated -->
        </div>

        <!-- Quests Section -->
        <h3>üéØ Quests</h3>
        <div id="quests">
            <!-- Quests will be dynamically generated -->
        </div>

        <!-- Control Buttons -->
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button onclick="saveGame()" aria-label="Save Game">üíæ Save Game</button>
            <button onclick="unlockTerraform()" aria-label="Terraform Planet">üåç Terraform Planet</button>
            <button onclick="resetGame()" aria-label="Reset Game">üóëÔ∏è Reset Game</button>
        </div>

        <!-- Theme Selector -->
        <div id="theme-selector">
            <label for="theme">üé® Select Theme: </label>
            <select id="theme" onchange="changeTheme(this.value)" aria-label="Theme Selector">
                <option value="default">Default</option>
                <option value="dark">Dark</option>
                <option value="light">Light</option>
            </select>
        </div>
    </div>

    <!-- Help Modal Script -->
    <script>
        function openHelp() {
            const modal = document.getElementById('help-modal');
            modal.style.display = 'block';
            const firstFocusable = modal.querySelector('button, [href], input, select, textarea, details,[tabindex]:not([tabindex="-1"])');
            if (firstFocusable) firstFocusable.focus();

            // Add event listener for focus trapping
            modal.addEventListener('keydown', trapTabKey);
        }

        function closeHelp() {
            const modal = document.getElementById('help-modal');
            modal.style.display = 'none';
            // Remove event listener when modal is closed
            modal.removeEventListener('keydown', trapTabKey);
        }

        function trapTabKey(e) {
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const modal = document.getElementById('help-modal');
            const firstFocusableElement = modal.querySelectorAll(focusableElements)[0];
            const focusableContent = modal.querySelectorAll(focusableElements);
            const lastFocusableElement = focusableContent[focusableContent.length - 1];

            if (e.key === 'Tab') {
                if (e.shiftKey) /* shift + tab */ {
                    if (document.activeElement === firstFocusableElement) {
                        e.preventDefault();
                        lastFocusableElement.focus();
                    }
                } else /* tab */ {
                    if (document.activeElement === lastFocusableElement) {
                        e.preventDefault();
                        firstFocusableElement.focus();
                    }
                }
            }
        }

        // Close the modal when clicking outside of the content
        window.onclick = function(event) {
            const modal = document.getElementById('help-modal');
            if (event.target == modal) {
                closeHelp();
            }
        }
    </script>

    <script>
        // Game State
        let resources = {
            water: 0,
            minerals: 0,
            plants: 0,
            energy: 0
        };

        let storage = {
            water: 1000,
            minerals: 500,
            plants: 300,
            energy: 200
        };

        let biomes = [];

        let upgrades = {
            waterBoost: {
                name: "üîß Improve Water Collection",
                description: "+10 Water per second",
                baseCost: 100,
                cost: 100,
                effect: (level) => { waterPerSecond += 10; },
                level: 0,
                category: "Resource Boost"
            },
            mineralsBoost: {
                name: "üîß Improve Mineral Extraction",
                description: "+5 Minerals per second",
                baseCost: 200,
                cost: 200,
                effect: (level) => { mineralsPerSecond += 5; },
                level: 0,
                category: "Resource Boost"
            },
            plantBoost: {
                name: "üîß Enhance Plant Growth",
                description: "+3 Plants per second",
                baseCost: 150,
                cost: 150,
                effect: (level) => { plantsPerSecond += 3; },
                level: 0,
                category: "Resource Boost"
            },
            energyBoost: {
                name: "üîß Boost Energy Generation",
                description: "+2 Energy per second",
                baseCost: 120,
                cost: 120,
                effect: (level) => { energyPerSecond += 2; },
                level: 0,
                category: "Resource Boost"
            },
            waterEfficiency: {
                name: "‚öôÔ∏è Water Efficiency",
                description: "Reduce Water consumption by 10%",
                baseCost: 300,
                cost: 300,
                effect: (level) => { 
                    waterConsumption = Math.max(waterConsumption * 0.9, 0.1); 
                },
                level: 0,
                category: "Efficiency Improvement"
            },
            mineralEfficiency: {
                name: "‚öôÔ∏è Mineral Efficiency",
                description: "Reduce Mineral consumption by 10%",
                baseCost: 350,
                cost: 350,
                effect: (level) => { 
                    mineralConsumption = Math.max(mineralConsumption * 0.9, 0.1); 
                },
                level: 0,
                category: "Efficiency Improvement"
            },
            waterStorage: {
                name: "üèóÔ∏è Expand Water Storage",
                description: "Increase Water storage capacity by 500",
                baseCost: 300,
                cost: 300,
                effect: (level) => { storage.water += 500; },
                level: 0,
                category: "Storage Upgrade"
            },
            mineralsStorage: {
                name: "üèóÔ∏è Expand Minerals Storage",
                description: "Increase Minerals storage capacity by 250",
                baseCost: 350,
                cost: 350,
                effect: (level) => { storage.minerals += 250; },
                level: 0,
                category: "Storage Upgrade"
            },
            plantsStorage: {
                name: "üèóÔ∏è Expand Plants Storage",
                description: "Increase Plants storage capacity by 150",
                baseCost: 250,
                cost: 250,
                effect: (level) => { storage.plants += 150; },
                level: 0,
                category: "Storage Upgrade"
            },
            energyStorage: {
                name: "üèóÔ∏è Expand Energy Storage",
                description: "Increase Energy storage capacity by 100",
                baseCost: 200,
                cost: 200,
                effect: (level) => { storage.energy += 100; },
                level: 0,
                category: "Storage Upgrade"
            }
            // Add more upgrades as needed
        };

        let waterPerSecond = 1;
        let mineralsPerSecond = 0;
        let plantsPerSecond = 0;
        let energyPerSecond = 0;

        let waterConsumption = 1; // Example usage
        let mineralConsumption = 1; // Example usage

        let resourceGenerationInterval;
        let autosaveInterval;
        let eventInterval;
        let resourceConsumptionInterval;

        let achievements = {
            firstWater: {
                name: "First Water",
                description: "Collect 100 Water",
                condition: () => resources.water >= 100,
                unlocked: false,
                reward: () => { resources.water += 50; },
                rewardDescription: "Water +50",
            },
            firstMineral: {
                name: "First Mineral",
                description: "Collect 50 Minerals",
                condition: () => resources.minerals >= 50,
                unlocked: false,
                reward: () => { resources.minerals += 25; },
                rewardDescription: "Minerals +25",
            },
            reach1000Water: {
                name: "Water Master",
                description: "Collect 1,000 Water",
                condition: () => resources.water >= 1000,
                unlocked: false,
                reward: () => { resources.water += 200; },
                rewardDescription: "Water +200",
            },
            reach500Minerals: {
                name: "Mineral Tycoon",
                description: "Collect 500 Minerals",
                condition: () => resources.minerals >= 500,
                unlocked: false,
                reward: () => { resources.energy += 50; },
                rewardDescription: "Energy +50",
            },
            // Add more achievements as needed
        };

        let quests = {
            dailyHarvest: {
                name: "Daily Harvest",
                description: "Collect 50 Plants today",
                condition: () => resources.plants >= 50,
                reward: () => { resources.water += 100; },
                rewardDescription: "Water +100",
                completed: false,
            },
            mineralMastery: {
                name: "Mineral Mastery",
                description: "Collect 300 Minerals this week",
                condition: () => resources.minerals >= 300,
                reward: () => { resources.energy += 50; },
                rewardDescription: "Energy +50",
                completed: false,
            },
            // Add more quests as needed
        };

        let storyMilestones = {
            unlockFirstBiome: {
                condition: () => biomes.length >= 1,
                text: "üåü You've unlocked your first biome! Explore and harness its resources to expand your planet.",
                unlocked: false
            },
            reach500Water: {
                condition: () => resources.water >= 500,
                text: "üíß With ample water, your planet begins to flourish. New possibilities emerge!",
                unlocked: false
            },
            // Add more story milestones as needed
        };

        // Events
        const eventTypes = [
            {
                name: "Resource Boom",
                description: "A sudden boom increases your Water and Minerals!",
                effect: () => {
                    resources.water += 50;
                    resources.minerals += 25;
                }
            },
            {
                name: "Drought",
                description: "A drought decreases your Water supply!",
                effect: () => {
                    resources.water = Math.max(0, resources.water - 30);
                }
            },
            {
                name: "Mineral Surge",
                description: "Mineral Surge! You received an extra 40 Minerals!",
                effect: () => {
                    resources.minerals += 40;
                }
            },
            {
                name: "Plant Overgrowth",
                description: "Plant Overgrowth! You received an extra 20 Plants!",
                effect: () => {
                    resources.plants += 20;
                }
            },
            // Add more events as needed
        ];

        // Maximum Resource Rates
        const MAX_RESOURCE_RATE = {
            waterPerSecond: 100,
            mineralsPerSecond: 50,
            plantsPerSecond: 30,
            energyPerSecond: 20
        };

        // Maximum Resources
        const MAX_RESOURCES = {
            water: 1000000,
            minerals: 500000,
            plants: 300000,
            energy: 200000
        };

        // Quests Completion and Reset
        function checkQuests() {
            for (let key in quests) {
                const quest = quests[key];
                if (!quest.completed && quest.condition()) {
                    quest.completed = true;
                    quest.reward();
                    showNotification(`üéØ Quest Completed: ${quest.name} - Reward: ${quest.rewardDescription}`);
                    generateQuestsUI();
                    saveGame();
                }
            }
        }

        function resetQuests() {
            for (let key in quests) {
                quests[key].completed = false;
            }
            generateQuestsUI();
        }

        // Save Game
        function saveGame() {
            try {
                const saveData = {
                    version: "0.2",
                    resources,
                    storage,
                    biomes,
                    upgrades,
                    waterPerSecond,
                    mineralsPerSecond,
                    plantsPerSecond,
                    energyPerSecond,
                    achievements,
                    quests,
                    storyMilestones,
                    lastUpdateTime: Date.now()
                };
                localStorage.setItem('PixelPlanetSave', JSON.stringify(saveData));
                showNotification("üíæ Game saved!");
            } catch (error) {
                console.error("Error saving game:", error);
                showNotification("‚ö†Ô∏è Error saving game.");
            }
        }

        // Load from Save Data
        function loadFromSave(gameState) {
            try {
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('game').style.display = 'flex';
                resources = gameState.resources;
                storage = gameState.storage;
                biomes = gameState.biomes;
                upgrades = gameState.upgrades;
                waterPerSecond = gameState.waterPerSecond;
                mineralsPerSecond = gameState.mineralsPerSecond;
                plantsPerSecond = gameState.plantsPerSecond;
                energyPerSecond = gameState.energyPerSecond;
                achievements = gameState.achievements;
                quests = gameState.quests;
                storyMilestones = gameState.storyMilestones;
                updateResourcesUI();
                generateUpgradesUI();
                generateAchievementsUI();
                generateQuestsUI();
                displayBiomes();
                handleOfflineResourceGeneration(gameState.lastUpdateTime);
                startResourceGeneration();
                startResourceConsumption();
                startAutosave();
                startEventSystem();
                scheduleQuestReset();
                checkAchievements();
                checkQuests();
                generateStoryUI();
                loadTheme();
                showNotification("‚úÖ Game loaded successfully!");
            } catch (error) {
                console.error("Error loading game:", error);
                showNotification("‚ö†Ô∏è Error loading game. Starting a new game.");
                startNewGame(false);
            }
        }

        // Start New Game
        function startNewGame(confirmStart=true) {
            if (confirmStart && !confirm("Are you sure you want to start a new game? All progress will be lost.")) {
                return;
            }
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game').style.display = 'flex';
            resources = { water: 0, minerals: 0, plants: 0, energy: 0 };
            storage = { water: 1000, minerals: 500, plants: 300, energy: 200 };
            biomes = [];
            resetUpgrades();
            resetAchievements();
            resetQuests();
            waterPerSecond = 1;
            mineralsPerSecond = 0;
            plantsPerSecond = 0;
            energyPerSecond = 0;
            waterConsumption = 1;
            mineralConsumption = 1;
            updateResourcesUI();
            generateUpgradesUI();
            generateAchievementsUI();
            generateQuestsUI();
            displayBiomes();
            generateStoryUI();
            startResourceGeneration();
            startResourceConsumption();
            startAutosave();
            startEventSystem();
            scheduleQuestReset();
            showNotification("üöÄ New game started! Welcome to Pixel Planet.");
            saveGame();
        }

        // Generate Resources Manually
        function generateResources() {
            addResource('water', 10);
            addResource('minerals', 5);
            addResource('plants', 3);
            addResource('energy', 2);
            updateResourcesUI();
            checkAchievements();
            checkQuests();
            showNotification("üîÑ Resources generated!");
            saveGame();
        }

        // Add Resource with Storage Limit and Caps
        function addResource(resource, amount) {
            if (!MAX_RESOURCES.hasOwnProperty(resource)) return;
            resources[resource] = Math.min(resources[resource] + amount, storage[resource], MAX_RESOURCES[resource]);
            saveGame(); // Save whenever resources change
        }

        // Update Resources UI
        function updateResourcesUI() {
            const waterElem = document.getElementById('water');
            const mineralsElem = document.getElementById('minerals');
            const plantsElem = document.getElementById('plants');
            const energyElem = document.getElementById('energy');

            waterElem.innerHTML = `üíß Water: ${resources.water} / ${storage.water} (Per Second: <span id="water-rate">${waterPerSecond}</span>)`;
            mineralsElem.innerHTML = `‚õè Minerals: ${resources.minerals} / ${storage.minerals} (Per Second: <span id="minerals-rate">${mineralsPerSecond}</span>)`;
            plantsElem.innerHTML = `üå± Plants: ${resources.plants} / ${storage.plants} (Per Second: <span id="plants-rate">${plantsPerSecond}</span>)`;
            energyElem.innerHTML = `‚ö° Energy: ${resources.energy} / ${storage.energy} (Per Second: <span id="energy-rate">${energyPerSecond}</span>)`;

            generateUpgradesUI(); // Update upgrade button states based on new resource counts

            checkStoryMilestones(); // Check for story milestones
        }

        // Generate Upgrades UI
        function generateUpgradesUI() {
            const upgradesDiv = document.getElementById('upgrades');
            upgradesDiv.innerHTML = ''; // Clear existing upgrades

            // Sort upgrades by category
            const categories = {};
            for (let key in upgrades) {
                const upgrade = upgrades[key];
                if (!categories[upgrade.category]) {
                    categories[upgrade.category] = [];
                }
                categories[upgrade.category].push({ key, ...upgrade });
            }

            for (let category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.style.width = '100%';
                categoryDiv.style.textAlign = 'left';
                categoryDiv.style.marginBottom = '10px';
                const categoryTitle = document.createElement('h4');
                categoryTitle.innerText = category;
                categoryDiv.appendChild(categoryTitle);

                // Create a flex container for upgrades to align left to right
                const upgradesRow = document.createElement('div');
                upgradesRow.style.display = 'flex';
                upgradesRow.style.flexWrap = 'wrap';
                upgradesRow.style.gap = '20px';
                upgradesRow.style.justifyContent = 'flex-start';

                categories[category].forEach(upgrade => {
                    const upgradeDiv = document.createElement('div');
                    upgradeDiv.className = 'upgrade';

                    const name = document.createElement('span');
                    name.innerText = `${upgrade.name}`;
                    upgradeDiv.appendChild(name);

                    const description = document.createElement('span');
                    description.innerText = `${upgrade.description}`;
                    upgradeDiv.appendChild(description);

                    const cost = document.createElement('span');
                    cost.innerText = `Cost: ${upgrade.cost} üíß`;
                    upgradeDiv.appendChild(cost);

                    const button = document.createElement('button');
                    button.className = 'upgrade-button';
                    button.innerText = `Buy (Level ${upgrade.level})`;
                    button.disabled = resources.water < upgrade.cost;
                    button.style.backgroundColor = resources.water < upgrade.cost ? '#888' : '#008CBA';
                    button.style.cursor = resources.water < upgrade.cost ? 'not-allowed' : 'pointer';
                    button.onclick = () => buyUpgrade(upgrade.key);
                    button.setAttribute('aria-label', `Buy upgrade ${upgrade.name}`);
                    upgradeDiv.appendChild(button);

                    upgradesRow.appendChild(upgradeDiv);
                });

                categoryDiv.appendChild(upgradesRow);
                upgradesDiv.appendChild(categoryDiv);
            }
        }

        // Buy Upgrade
        function buyUpgrade(upgradeKey) {
            const upgrade = upgrades[upgradeKey];
            if (!upgrade) return;

            if (resources.water >= upgrade.cost) {
                resources.water -= upgrade.cost;
                upgrade.level += 1;
                upgrade.effect(upgrade.level);
                upgrade.cost = Math.floor(upgrade.baseCost * Math.pow(1.5, upgrade.level));
                updateResourcesUI();
                generateAchievementsUI();
                checkAchievements();
                showNotification(`üîß Upgrade "${upgrade.name}" purchased! Level: ${upgrade.level}`);
                saveGame();
            } else {
                showNotification("‚ùå Not enough Water to purchase this upgrade!");
            }
        }

        // Reset Upgrades (for new game)
        function resetUpgrades() {
            for (let key in upgrades) {
                upgrades[key].level = 0;
                upgrades[key].cost = upgrades[key].baseCost;
            }
        }

        // Achievements UI
        function generateAchievementsUI() {
            const achievementsDiv = document.getElementById('achievements');
            achievementsDiv.innerHTML = ''; // Clear existing achievements

            for (let key in achievements) {
                const achievement = achievements[key];
                const achievementDiv = document.createElement('div');
                achievementDiv.className = 'achievement';
                if (achievement.unlocked) {
                    achievementDiv.classList.add('unlocked');
                }

                const name = document.createElement('span');
                name.innerText = `${achievement.name}`;
                achievementDiv.appendChild(name);

                const description = document.createElement('span');
                description.innerText = `${achievement.description}`;
                achievementDiv.appendChild(description);

                achievementsDiv.appendChild(achievementDiv);
            }
        }

        // Check and Unlock Achievements
        function checkAchievements() {
            for (let key in achievements) {
                const achievement = achievements[key];
                if (!achievement.unlocked && achievement.condition()) {
                    achievement.unlocked = true;
                    if (achievement.reward) achievement.reward();
                    showNotification(`üèÜ Achievement Unlocked: ${achievement.name} - Reward: ${achievement.rewardDescription}`);
                    generateAchievementsUI();
                    saveGame();
                }
            }
        }

        // Reset Achievements (for new game)
        function resetAchievements() {
            for (let key in achievements) {
                achievements[key].unlocked = false;
            }
        }

        // Quests UI
        function generateQuestsUI() {
            const questsDiv = document.getElementById('quests');
            questsDiv.innerHTML = ''; // Clear existing quests

            for (let key in quests) {
                const quest = quests[key];
                const questDiv = document.createElement('div');
                questDiv.className = 'quest';
                questDiv.innerText = `${quest.name}: ${quest.description} - ${quest.completed ? '‚úÖ Completed' : '‚ùå Incomplete'}`;
                questsDiv.appendChild(questDiv);
            }
        }

        // Check and Unlock Quests
        function checkQuests() {
            for (let key in quests) {
                const quest = quests[key];
                if (!quest.completed && quest.condition()) {
                    quest.completed = true;
                    quest.reward();
                    showNotification(`üéØ Quest Completed: ${quest.name} - Reward: ${quest.rewardDescription}`);
                    generateQuestsUI();
                    saveGame();
                }
            }
        }

        // Reset Quests (for new game)
        function resetQuests() {
            for (let key in quests) {
                quests[key].completed = false;
            }
            generateQuestsUI();
        }

        // Display Story Milestones
        function generateStoryUI() {
            const storyDiv = document.getElementById('story');
            if (!storyDiv) return; // If no story section, exit

            storyDiv.innerHTML = ''; // Clear existing story

            for (let key in storyMilestones) {
                const milestone = storyMilestones[key];
                if (milestone.unlocked) {
                    const paragraph = document.createElement('p');
                    paragraph.innerText = milestone.text;
                    storyDiv.appendChild(paragraph);
                }
            }
        }

        // Check and Unlock Story Milestones
        function checkStoryMilestones() {
            for (let key in storyMilestones) {
                const milestone = storyMilestones[key];
                if (!milestone.unlocked && milestone.condition()) {
                    milestone.unlocked = true;
                    showNotification(`üìñ Story Update: ${milestone.text}`);
                    generateStoryUI();
                    saveGame();
                }
            }
        }

        // Display Biomes
        function displayBiomes() {
            const biomesDiv = document.getElementById('biomes');
            biomesDiv.innerHTML = ''; // Clear existing biomes

            biomes.forEach(biome => {
                const biomeDiv = document.createElement('div');
                biomeDiv.className = 'biome';
                let bonusText = '';
                for (let key in biome.bonuses) {
                    bonusText += `+${biome.bonuses[key]} ${key.replace('PerSecond', '')} / sec\n`;
                }
                biomeDiv.innerText = `${biome.name} Biome\n${bonusText}`;
                biomesDiv.appendChild(biomeDiv);
            });
        }

        // Unlock Terraform (New Biome)
        function unlockTerraform() {
            const terraformBaseCost = 500;
            const terraformCost = terraformBaseCost * (biomes.length + 1);
            if (resources.water >= terraformCost) {
                if (confirm(`Are you sure you want to terraform the planet for ${terraformCost} üíß Water?`)) {
                    resources.water -= terraformCost;
                    unlockNewBiome();
                    updateResourcesUI();
                    showNotification(`üåç Planet terraformed! New biome unlocked.`);
                    saveGame();
                }
            } else {
                showNotification("‚ùå Not enough Water to terraform the planet!");
            }
        }

        // Unlock New Biome
        function unlockNewBiome() {
            const newBiome = generateRandomBiome();
            biomes.push(newBiome);
            displayBiomes();
            generateStoryUI();
        }

        // Generate Random Biome
        function generateRandomBiome() {
            const biomeNames = ["Forest", "Desert", "Ocean", "Mountain", "Swamp", "Tundra", "Savanna"];
            const randomName = biomeNames[Math.floor(Math.random() * biomeNames.length)];
            let resourceBonus = {};

            switch(randomName) {
                case "Forest":
                    resourceBonus = { plantsPerSecond: 2 };
                    break;
                case "Desert":
                    resourceBonus = { mineralsPerSecond: 3 };
                    break;
                case "Ocean":
                    resourceBonus = { waterPerSecond: 5 };
                    break;
                case "Mountain":
                    resourceBonus = { mineralsPerSecond: 4 };
                    break;
                case "Swamp":
                    resourceBonus = { plantsPerSecond: 3, waterPerSecond: 2 };
                    break;
                case "Tundra":
                    resourceBonus = { energyPerSecond: 2 };
                    break;
                case "Savanna":
                    resourceBonus = { plantsPerSecond: 2, mineralsPerSecond: 2 };
                    break;
                default:
                    resourceBonus = {};
            }

            // Apply bonuses with caps
            for (let key in resourceBonus) {
                if (key === "waterPerSecond") {
                    waterPerSecond = Math.min(waterPerSecond + resourceBonus[key], MAX_RESOURCE_RATE.waterPerSecond);
                }
                if (key === "mineralsPerSecond") {
                    mineralsPerSecond = Math.min(mineralsPerSecond + resourceBonus[key], MAX_RESOURCE_RATE.mineralsPerSecond);
                }
                if (key === "plantsPerSecond") {
                    plantsPerSecond = Math.min(plantsPerSecond + resourceBonus[key], MAX_RESOURCE_RATE.plantsPerSecond);
                }
                if (key === "energyPerSecond") {
                    energyPerSecond = Math.min(energyPerSecond + resourceBonus[key], MAX_RESOURCE_RATE.energyPerSecond);
                }
            }

            return { name: randomName, id: biomes.length + 1, bonuses: resourceBonus };
        }

        // Event System
        function startEventSystem() {
            if (eventInterval) clearInterval(eventInterval);
            eventInterval = setInterval(() => {
                triggerRandomEvent();
            }, 600000); // Trigger an event every 10 minutes
        }

        function triggerRandomEvent() {
            const randomEvent = eventTypes[Math.floor(Math.random() * eventTypes.length)];
            randomEvent.effect();
            showNotification(`üéâ Event: ${randomEvent.name} - ${randomEvent.description}`);
            displayEvents(randomEvent);
            updateResourcesUI();
            checkAchievements();
            checkQuests();
            saveGame();
        }

        function displayEvents(event) {
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event';
            eventDiv.innerText = `${event.name}: ${event.description}`;
            eventsDiv.prepend(eventDiv); // Add to top

            // Limit the number of displayed events to 5
            while (eventsDiv.children.length > 5) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        // Notifications
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.innerText = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Save Game on Window Unload
        window.addEventListener('beforeunload', saveGame);

        // Start Resource Generation
        function startResourceGeneration() {
            if (resourceGenerationInterval) clearInterval(resourceGenerationInterval);
            resourceGenerationInterval = setInterval(() => {
                addResource('water', waterPerSecond);
                addResource('minerals', mineralsPerSecond);
                addResource('plants', plantsPerSecond);
                addResource('energy', energyPerSecond);
                updateResourcesUI();
                checkAchievements();
                checkQuests();
            }, 1000);
        }

        // Start Resource Consumption
        function startResourceConsumption() {
            if (resourceConsumptionInterval) clearInterval(resourceConsumptionInterval);
            resourceConsumptionInterval = setInterval(() => {
                consumeResources();
            }, 5000); // Consume resources every 5 seconds
        }

        function consumeResources() {
            resources.water = Math.max(0, resources.water - waterConsumption);
            resources.minerals = Math.max(0, resources.minerals - mineralConsumption);
            updateResourcesUI();
            checkAchievements();
            checkQuests();
        }

        // Start Autosave Functionality
        function startAutosave() {
            if (autosaveInterval) clearInterval(autosaveInterval);
            autosaveInterval = setInterval(() => {
                saveGame();
            }, 30000); // Autosave every 30 seconds
        }

        // Handle Offline Resource Generation
        function handleOfflineResourceGeneration(lastSaveTime) {
            const currentTime = Date.now();
            const offlineDuration = Math.floor((currentTime - lastSaveTime) / 1000); // in seconds
            const maxOfflineSeconds = 86400; // 24 hours
            const effectiveDuration = Math.min(offlineDuration, maxOfflineSeconds);
            if (effectiveDuration > 0) {
                const multiplier = 1; // Adjust as needed
                addResource('water', effectiveDuration * waterPerSecond * multiplier);
                addResource('minerals', effectiveDuration * mineralsPerSecond * multiplier);
                addResource('plants', effectiveDuration * plantsPerSecond * multiplier);
                addResource('energy', effectiveDuration * energyPerSecond * multiplier);
                updateResourcesUI();
                showNotification(`‚è∞ You were offline for ${effectiveDuration} seconds. Resources have been updated.`);
                checkAchievements();
                checkQuests();
                saveGame();
            }
        }

        // Schedule Quest Reset (Daily)
        function scheduleQuestReset() {
            const now = new Date();
            const millisTillMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0) - now;
            setTimeout(function(){
                resetQuests();
                scheduleQuestReset();
            }, millisTillMidnight);
        }

        // Device Detection for UI Adjustments
        function detectDevice() {
            const ua = navigator.userAgent;
            if (/Mobi|Android/i.test(ua)) {
                document.body.style.fontSize = '1em';
            } else if (/iPad|Tablet/i.test(ua)) {
                document.body.style.fontSize = '1.1em';
            } else {
                document.body.style.fontSize = '1.2em';
            }
        }

        // Initialize Game
        function initGame() {
            const savedGame = localStorage.getItem('PixelPlanetSave');
            if (savedGame) {
                const parsedSave = JSON.parse(savedGame);
                if (parsedSave.version !== "0.2") {
                    // Handle version upgrades if necessary
                    // For simplicity, start a new game if versions do not match
                    showNotification("üîÑ Game version mismatch. Starting a new game.");
                    startNewGame(false);
                } else {
                    loadFromSave(parsedSave);
                }
            } else {
                startNewGame();
            }
        }

        // Change Theme
        function changeTheme(theme) {
            document.body.className = ''; // Reset existing classes
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                // Default theme
                document.body.classList.remove('dark-theme', 'light-theme');
            }
            showNotification(`üñåÔ∏è Theme changed to ${theme.charAt(0).toUpperCase() + theme.slice(1)}`);
            // Save theme selection
            localStorage.setItem('PixelPlanetTheme', theme);
        }

        // Load Theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('PixelPlanetTheme');
            if (savedTheme) {
                changeTheme(savedTheme);
                document.getElementById('theme').value = savedTheme;
            }
        }

        // Reset Game
        function resetGame() {
            if (confirm("Are you sure you want to reset the game? All progress will be lost.")) {
                localStorage.removeItem('PixelPlanetSave');
                startNewGame(false); // Pass false to avoid double confirmation
                showNotification("üóëÔ∏è Game has been reset.");
            }
        }

        // Ensure 'story' Div Exists in HTML (Add Below Game Interface)
        document.addEventListener("DOMContentLoaded", function() {
            const gameDiv = document.getElementById('game');
            const storySection = document.createElement('div');
            storySection.id = 'story';
            const storyHeading = document.createElement('h3');
            storyHeading.innerText = 'üìñ Story';
            storySection.appendChild(storyHeading);
            gameDiv.appendChild(storySection);
        });

    </script>
</body>
</html>
